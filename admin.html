<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>The Grinders | Admin</title>
  <link rel="stylesheet" href="./assets/css/cafe-theme.css">
</head>

<body>
  <header>
    <div>
      <div style="font-weight:800">Admin Panel</div>
      <div class="muted" id="who">...</div>
    </div>
    <button class="btn" id="logoutBtn">Logout</button>
  </header>

  <div class="wrap">

    <!-- ========= Users Management ========= -->
    <div class="card">
      <h2>إضافة/تحديث موظف (يدوي)</h2>
      <div class="muted">مهم: UID لازم يكون من Firebase Auth (Users)</div>

      <div class="row" style="margin-top:10px">
        <input id="uid" placeholder="UID" />
        <input id="name" placeholder="اسم الموظف" />
        <select id="role">
          <option value="employee">Employee</option>
          <option value="admin">Admin</option>
        </select>
      </div>

      <div class="row" style="margin-top:10px">
        <select id="active">
          <option value="true">فعال</option>
          <option value="false">غير فعال</option>
        </select>
        <input id="deviceId" placeholder="Device ID (اختياري)" />
        <button class="btn" id="saveBtn">حفظ</button>
      </div>

      <div id="saveMsg" class="msg"></div>
    </div>

    <div class="card">
      <h2>الموظفون</h2>
      <div class="muted" id="listHint">Loading...</div>
      <div style="overflow:auto">
        <table>
          <thead>
            <tr>
              <th>الاسم</th>
              <th>الدور</th>
              <th>الحالة</th>
              <th>UID</th>
              <th>البريد</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
      <div id="listMsg" class="msg"></div>
    </div>

    <!-- ========= Reports ========= -->
    <div class="card">
      <h2>Reports | التقارير</h2>
      <div class="muted">فلترة حسب الموظف وحالة الحضور (Checked in / Checked out)</div>

      <div class="row" style="margin-top:10px">
        <select id="repEmployee">
          <option value="all">All employees | كل الموظفين</option>
        </select>

        <select id="repState">
          <option value="all">All | الكل</option>
          <option value="in">Checked in (not checked out)</option>
          <option value="out">Checked out</option>
        </select>

        <button class="btn" id="repRefreshBtn">تحديث | Refresh</button>
        <button class="btn" id="repExportBtn">Export CSV</button>
      </div>

      <div class="muted" id="repHint" style="margin-top:10px">Loading...</div>

      <div style="overflow:auto; margin-top:10px">
        <table>
          <thead>
            <tr>
              <th>Date | التاريخ</th>
              <th>Name | الاسم</th>
              <th>UID</th>
              <th>Shift</th>
              <th>Status</th>
              <th>Check In</th>
              <th>Check Out</th>
              <th>Late (min)</th>
              <th>Distance (m)</th>
            </tr>
          </thead>
          <tbody id="repBody"></tbody>
        </table>
      </div>

      <div id="repMsg" class="msg"></div>
    </div>

    <!-- ========= Audit Logs ========= -->
    <div class="card">
      <h2>Audit Logs | سجل التدقيق</h2>
      <div class="muted">فلترة حسب الموظف/نوع الحدث/السبب + تاريخ (من/إلى)</div>

      <div class="row" style="margin-top:10px">
        <input type="date" id="audFrom" />
        <input type="date" id="audTo" />

        <select id="audEmployee">
          <option value="all">All employees | كل الموظفين</option>
        </select>

        <select id="audType">
          <option value="all">All event types</option>
          <option value="LOGIN">LOGIN</option>
          <option value="LOGOUT">LOGOUT</option>
          <option value="CHECK_IN">CHECK_IN</option>
          <option value="CHECK_OUT">CHECK_OUT</option>
          <option value="DENIED">DENIED</option>
        </select>

        <select id="audReason">
          <option value="all">All reasons</option>
          <option value="success">success</option>
          <option value="out_of_range">out_of_range</option>
          <option value="gps_weak">gps_weak</option>
          <option value="device_mismatch">device_mismatch</option>
          <option value="gps_error">gps_error</option>
        </select>
      </div>

      <div class="row" style="margin-top:10px">
        <button class="btn" id="audRefreshBtn">تحديث | Refresh</button>
        <button class="btn" id="audExportBtn">Export CSV</button>
      </div>

      <div class="muted" id="audHint" style="margin-top:10px">Loading...</div>

      <div style="overflow:auto; margin-top:10px">
        <table>
          <thead>
            <tr>
              <th>Time</th>
              <th>Name</th>
              <th>UID</th>
              <th>Event</th>
              <th>Reason</th>
              <th>Device ID</th>
              <th>Distance (m)</th>
              <th>Accuracy (m)</th>
            </tr>
          </thead>
          <tbody id="audBody"></tbody>
        </table>
      </div>

      <div id="audMsg" class="msg"></div>
    </div>

  </div>

  <script type="module">
    import { requireRole } from "./js/auth-guard.js";
    import { logout } from "./js/auth.js";
    import {
      db,
      doc, getDoc, setDoc, updateDoc, serverTimestamp,
      collection, getDocs
    } from "./js/firebase.js";

    // Firestore query helpers (CDN) - no dependency on your firebase.js exports
    import {
      query, where, orderBy, limit, Timestamp
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const who = document.getElementById("who");
    const logoutBtn = document.getElementById("logoutBtn");

    const uidEl = document.getElementById("uid");
    const nameEl = document.getElementById("name");
    const roleEl = document.getElementById("role");
    const activeEl = document.getElementById("active");
    const deviceEl = document.getElementById("deviceId");
    const saveBtn = document.getElementById("saveBtn");
    const saveMsg = document.getElementById("saveMsg");

    const tbody = document.getElementById("tbody");
    const listHint = document.getElementById("listHint");
    const listMsg = document.getElementById("listMsg");

    // Reports UI
    const repEmployee = document.getElementById("repEmployee");
    const repState = document.getElementById("repState");
    const repRefreshBtn = document.getElementById("repRefreshBtn");
    const repExportBtn = document.getElementById("repExportBtn");
    const repHint = document.getElementById("repHint");
    const repBody = document.getElementById("repBody");
    const repMsg = document.getElementById("repMsg");

    // Audit UI
    const audFrom = document.getElementById("audFrom");
    const audTo = document.getElementById("audTo");
    const audEmployee = document.getElementById("audEmployee");
    const audType = document.getElementById("audType");
    const audReason = document.getElementById("audReason");
    const audRefreshBtn = document.getElementById("audRefreshBtn");
    const audExportBtn = document.getElementById("audExportBtn");
    const audHint = document.getElementById("audHint");
    const audBody = document.getElementById("audBody");
    const audMsg = document.getElementById("audMsg");

    function setMsg(el, text, kind){
      el.textContent = text || "";
      el.className = "msg" + (kind ? (" " + kind) : "");
    }

    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, (c)=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));
    }

    function tsToText(v){
      if(!v) return "";
      try{
        if(typeof v.toDate === "function") return v.toDate().toLocaleString();
        const d = new Date(v);
        if(!isNaN(d.getTime())) return d.toLocaleString();
        return String(v);
      }catch{
        return String(v);
      }
    }

    function dateToRangeTS(dateStr, endOfDay=false){
      if(!dateStr) return null;
      const d = new Date(dateStr + "T00:00:00");
      if(endOfDay){
        d.setHours(23,59,59,999);
      }
      return Timestamp.fromDate(d);
    }

    logoutBtn.addEventListener("click", async ()=>{
      await logout();
      window.location.replace("./login.html");
    });

    const session = await requireRole("admin");
    who.textContent = session.user.email || session.user.uid;

    // ========= Users List =========
    let cachedUsers = [];

    async function loadUsers(){
      listHint.textContent = "Loading...";
      tbody.innerHTML = "";
      setMsg(listMsg, "", "");

      try{
        const snap = await getDocs(collection(db, "users"));
        const rows = [];
        snap.forEach(docu => rows.push({ id: docu.id, ...docu.data() }));

        rows.sort((a,b)=> (a.name||"").localeCompare(b.name||""));
        cachedUsers = rows;

        if(rows.length === 0){
          listHint.textContent = "لا يوجد موظفين داخل users collection.";
          fillEmployeeFilter([]);
          fillAuditEmployeeFilter([]);
          return;
        }

        listHint.textContent = "";

        tbody.innerHTML = rows.map(u => `
          <tr>
            <td>${escapeHtml(u.name || "-")}</td>
            <td>${escapeHtml((u.role || "employee"))}</td>
            <td>${u.active === false ? "غير فعال" : "فعال"}</td>
            <td style="font-family:monospace">${escapeHtml(u.id)}</td>
            <td>${escapeHtml(u.email || "-")}</td>
          </tr>
        `).join("");

        fillEmployeeFilter(rows);
        fillAuditEmployeeFilter(rows);

      }catch(e){
        console.error(e);
        listHint.textContent = "";
        setMsg(listMsg, "مشكلة بقراءة Firestore. راجع Rules أو الصلاحيات.", "err");
        fillEmployeeFilter([]);
        fillAuditEmployeeFilter([]);
      }
    }

    function fillEmployeeFilter(users){
      const prev = repEmployee.value || "all";
      const opts = [
        `<option value="all">All employees | كل الموظفين</option>`,
        ...users
          .filter(u => (u.role || "employee") !== "admin")
          .map(u => `<option value="${escapeHtml(u.id)}">${escapeHtml(u.name || u.id)}</option>`)
      ];
      repEmployee.innerHTML = opts.join("");
      const stillExists = Array.from(repEmployee.options).some(o => o.value === prev);
      repEmployee.value = stillExists ? prev : "all";
    }

    function fillAuditEmployeeFilter(users){
      const prev = audEmployee.value || "all";
      const opts = [
        `<option value="all">All employees | كل الموظفين</option>`,
        ...users
          .filter(u => (u.role || "employee") !== "admin")
          .map(u => `<option value="${escapeHtml(u.id)}">${escapeHtml(u.name || u.id)}</option>`)
      ];
      audEmployee.innerHTML = opts.join("");
      const stillExists = Array.from(audEmployee.options).some(o => o.value === prev);
      audEmployee.value = stillExists ? prev : "all";
    }

    function uidToName(uid){
      const u = cachedUsers.find(x => x.id === uid);
      return u?.name || uid || "-";
    }

    saveBtn.addEventListener("click", async ()=>{
      setMsg(saveMsg,"","");

      const uid = uidEl.value.trim();
      const name = nameEl.value.trim();
      const role = roleEl.value;
      const active = activeEl.value === "true";
      const deviceId = deviceEl.value.trim();

      if(!uid){
        setMsg(saveMsg,"UID مطلوب", "err");
        return;
      }

      try{
        const ref = doc(db, "users", uid);
        const base = {
          name,
          role,
          active,
          updatedAt: serverTimestamp(),
        };
        if(deviceId) base.deviceId = deviceId;

        const snap = await getDoc(ref);
        if(!snap.exists()){
          await setDoc(ref, { ...base, createdAt: serverTimestamp() }, { merge: true });
        }else{
          await updateDoc(ref, base);
        }

        setMsg(saveMsg,"تم الحفظ ✅", "ok");
        await loadUsers();

      }catch(e){
        console.error(e);
        setMsg(saveMsg,"فشل الحفظ. غالبًا Rules تمنع الكتابة.", "err");
      }
    });

    // ========= Reports =========
    let cachedAttendance = [];
    let lastRenderedRows = [];

    async function loadAttendance(){
      repHint.textContent = "Loading...";
      repBody.innerHTML = "";
      setMsg(repMsg, "", "");

      try{
        const snap = await getDocs(collection(db, "attendance"));
        const rows = [];
        snap.forEach(d => rows.push({ id: d.id, ...d.data() }));

        rows.sort((a,b)=>{
          const ad = a.checkInAt?.toDate ? a.checkInAt.toDate().getTime() : new Date(a.checkInAt || a.dateKey || 0).getTime();
          const bd = b.checkInAt?.toDate ? b.checkInAt.toDate().getTime() : new Date(b.checkInAt || b.dateKey || 0).getTime();
          return bd - ad;
        });

        cachedAttendance = rows;
        renderAttendance();

        if(rows.length === 0){
          repHint.textContent = "لا توجد سجلات attendance حالياً.";
        }else{
          repHint.textContent = "";
        }

      }catch(e){
        console.error("Attendance load error:", e);
        repHint.textContent = "";
        setMsg(repMsg, "مشكلة بقراءة attendance. راجع Rules أو اسم الكولكشن.", "err");
        repBody.innerHTML = "";
        lastRenderedRows = [];
      }
    }

    function renderAttendance(){
      const emp = repEmployee.value;
      const st = repState.value;

      let rows = cachedAttendance.slice();

      if(emp !== "all"){
        rows = rows.filter(r =>
          (r.uid === emp) ||
          (r.userId === emp) ||
          (r.employeeUid === emp) ||
          (r.id === emp)
        );
      }

      if(st === "in"){
        rows = rows.filter(r => !!r.checkInAt && !r.checkOutAt);
      }else if(st === "out"){
        rows = rows.filter(r => !!r.checkInAt && !!r.checkOutAt);
      }

      lastRenderedRows = rows;

      repBody.innerHTML = rows.map(r=>{
        const name = r.name || r.employeeName || "-";
        const uid = r.uid || r.userId || r.employeeUid || "-";
        const shift = r.shift || "-";
        const status = r.status || "-";
        const late = (r.lateMinutes ?? "-");
        const dist = (r.distanceM ?? r.checkOutDistanceM ?? "-");

        return `
          <tr>
            <td>${escapeHtml(r.dateKey || "-")}</td>
            <td>${escapeHtml(name)}</td>
            <td style="font-family:monospace">${escapeHtml(uid)}</td>
            <td>${escapeHtml(shift)}</td>
            <td>${escapeHtml(status)}</td>
            <td>${escapeHtml(tsToText(r.checkInAt))}</td>
            <td>${escapeHtml(tsToText(r.checkOutAt))}</td>
            <td>${escapeHtml(late)}</td>
            <td>${escapeHtml(dist)}</td>
          </tr>
        `;
      }).join("");

      repHint.textContent = rows.length ? "" : "لا توجد نتائج مطابقة للفلاتر.";
    }

    function exportCSV(){
      if(!lastRenderedRows || lastRenderedRows.length === 0){
        setMsg(repMsg, "ماكو بيانات لتصديرها حسب الفلاتر الحالية.", "err");
        return;
      }
      setMsg(repMsg, "", "");

      const headers = ["dateKey","name","uid","shift","status","checkInAt","checkOutAt","lateMinutes","distanceM"];
      const lines = [headers.join(",")];

      for(const r of lastRenderedRows){
        const name = r.name || r.employeeName || "";
        const uid  = r.uid || r.userId || r.employeeUid || "";
        const dist = (r.distanceM ?? r.checkOutDistanceM ?? "");

        const row = [
          r.dateKey || "",
          name,
          uid,
          r.shift || "",
          r.status || "",
          tsToText(r.checkInAt),
          tsToText(r.checkOutAt),
          (r.lateMinutes ?? ""),
          dist
        ].map(v => `"${String(v ?? "").replace(/"/g, '""')}"`);

        lines.push(row.join(","));
      }

      const csv = "\uFEFF" + lines.join("\n");
      const blob = new Blob([csv], { type: "text/csv;charset=utf-8" });
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = `attendance_report_${new Date().toISOString().slice(0,10)}.csv`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);

      setMsg(repMsg, "تم تصدير CSV ✅", "ok");
    }

    repEmployee.addEventListener("change", renderAttendance);
    repState.addEventListener("change", renderAttendance);
    repRefreshBtn.addEventListener("click", loadAttendance);
    repExportBtn.addEventListener("click", exportCSV);

    // ========= Audit Logs =========
    let cachedAudit = [];
    let lastAuditRows = [];

    async function loadAudit(){
      audHint.textContent = "Loading...";
      audBody.innerHTML = "";
      setMsg(audMsg, "", "");

      try{
        const fromTS = dateToRangeTS(audFrom.value, false);
        const toTS = dateToRangeTS(audTo.value, true);

        // Keep server query simple to avoid indexes:
        // filter by date range only, other filters are client-side.
        const constraints = [];
        if(fromTS) constraints.push(where("createdAt", ">=", fromTS));
        if(toTS) constraints.push(where("createdAt", "<=", toTS));
        constraints.push(orderBy("createdAt", "desc"));
        constraints.push(limit(500));

        const q = query(collection(db, "audit_logs"), ...constraints);
        const snap = await getDocs(q);

        const rows = [];
        snap.forEach(d => rows.push({ id: d.id, ...d.data() }));

        cachedAudit = rows;
        renderAudit();

        audHint.textContent = rows.length ? "" : "لا توجد سجلات ضمن هذا النطاق.";

      }catch(e){
        console.error("Audit load error:", e);
        audHint.textContent = "";
        setMsg(audMsg, "مشكلة بقراءة audit_logs. راجع Rules (read للأدمن) أو الاسم audit_logs.", "err");
        audBody.innerHTML = "";
        lastAuditRows = [];
      }
    }

    function renderAudit(){
      const emp = audEmployee.value;
      const type = audType.value;
      const reason = audReason.value;

      let rows = cachedAudit.slice();

      if(emp !== "all"){
        rows = rows.filter(r => (r.uid === emp));
      }
      if(type !== "all"){
        rows = rows.filter(r => (r.eventType || "") === type);
      }
      if(reason !== "all"){
        rows = rows.filter(r => (r.reason || "") === reason);
      }

      lastAuditRows = rows;

      audBody.innerHTML = rows.map(r=>{
        const time = tsToText(r.createdAt);
        const uid = r.uid || "-";
        const name = uidToName(uid);
        const ev = r.eventType || "-";
        const rs = r.reason || "-";
        const deviceId = r.deviceId || "-";
        const dist = (r.distanceM ?? "-");
        const acc = (r.accuracyM ?? "-");

        return `
          <tr>
            <td>${escapeHtml(time)}</td>
            <td>${escapeHtml(name)}</td>
            <td style="font-family:monospace">${escapeHtml(uid)}</td>
            <td>${escapeHtml(ev)}</td>
            <td>${escapeHtml(rs)}</td>
            <td style="font-family:monospace">${escapeHtml(deviceId)}</td>
            <td>${escapeHtml(dist)}</td>
            <td>${escapeHtml(acc)}</td>
          </tr>
        `;
      }).join("");

      audHint.textContent = rows.length ? "" : "لا توجد نتائج مطابقة للفلاتر.";
    }

    function exportAuditCSV(){
      if(!lastAuditRows || lastAuditRows.length === 0){
        setMsg(audMsg, "ماكو بيانات لتصديرها حسب الفلاتر الحالية.", "err");
        return;
      }
      setMsg(audMsg, "", "");

      const headers = ["createdAt","name","uid","eventType","reason","deviceId","distanceM","accuracyM","email"];
      const lines = [headers.join(",")];

      for(const r of lastAuditRows){
        const uid = r.uid || "";
        const row = [
          tsToText(r.createdAt),
          uidToName(uid),
          uid,
          r.eventType || "",
          r.reason || "",
          r.deviceId || "",
          (r.distanceM ?? ""),
          (r.accuracyM ?? ""),
          (r.email || "")
        ].map(v => `"${String(v ?? "").replace(/"/g, '""')}"`);

        lines.push(row.join(","));
      }

      const csv = "\uFEFF" + lines.join("\n");
      const blob = new Blob([csv], { type: "text/csv;charset=utf-8" });
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = `audit_logs_${new Date().toISOString().slice(0,10)}.csv`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);

      setMsg(audMsg, "تم تصدير CSV ✅", "ok");
    }

    audEmployee.addEventListener("change", renderAudit);
    audType.addEventListener("change", renderAudit);
    audReason.addEventListener("change", renderAudit);
    audRefreshBtn.addEventListener("click", loadAudit);
    audExportBtn.addEventListener("click", exportAuditCSV);

    // Start
    await loadUsers();
    await loadAttendance();
    await loadAudit();
  </script>
</body>
</html>
